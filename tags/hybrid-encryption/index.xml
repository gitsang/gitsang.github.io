<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Hybrid Encryption on Sang's Blog</title><link>https://gitsang.github.io/tags/hybrid-encryption/</link><description>Recent content in Hybrid Encryption on Sang's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 12 May 2025 10:40:30 +0800</lastBuildDate><atom:link href="https://gitsang.github.io/tags/hybrid-encryption/index.xml" rel="self" type="application/rss+xml"/><item><title>Efficient Large File Encryption Using Passphrase and RSA</title><link>https://gitsang.github.io/p/efficient-large-file-encryption-using-passphrase-and-rsa/</link><pubDate>Fri, 09 May 2025 19:17:07 +0800</pubDate><guid>https://gitsang.github.io/p/efficient-large-file-encryption-using-passphrase-and-rsa/</guid><description>&lt;!-- markdown-front-matter -->
&lt;h2 id="1-概述">&lt;a href="#1-%e6%a6%82%e8%bf%b0" class="header-anchor">&lt;/a>1. 概述
&lt;/h2>&lt;p>通常，非对称加密有较低的性能，如果对大文件直接使用非对称加密可能导致高负载和高耗时（过大的文件还有可能出现报错 &lt;code>RSA_padding_add_PKCS1_type_2: data too large for key size&lt;/code>）。&lt;/p>
&lt;p>因此对于大文件的加密，一般使用密码短语（&lt;code>passphrase&lt;/code>）进行加密，然后使用非对称加密来加密密码短语（&lt;code>passphrase&lt;/code>）&lt;/p>
&lt;h3 id="11-poc">&lt;a href="#11-poc" class="header-anchor">&lt;/a>1.1 POC
&lt;/h3>&lt;h4 id="111-生成随机待加密文件">&lt;a href="#111-%e7%94%9f%e6%88%90%e9%9a%8f%e6%9c%ba%e5%be%85%e5%8a%a0%e5%af%86%e6%96%87%e4%bb%b6" class="header-anchor">&lt;/a>1.1.1 生成随机待加密文件
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">dd &lt;span class="k">if&lt;/span>&lt;span class="o">=&lt;/span>/dev/urandom &lt;span class="nv">of&lt;/span>&lt;span class="o">=&lt;/span>firmware &lt;span class="nv">bs&lt;/span>&lt;span class="o">=&lt;/span>1M &lt;span class="nv">count&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="112-生成-rsa-密钥对">&lt;a href="#112-%e7%94%9f%e6%88%90-rsa-%e5%af%86%e9%92%a5%e5%af%b9" class="header-anchor">&lt;/a>1.1.2 生成 RSA 密钥对
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">openssl genrsa -out private.pem &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl rsa -in private.pem -pubout -out public.pem
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="113-打包并加密文件">&lt;a href="#113-%e6%89%93%e5%8c%85%e5%b9%b6%e5%8a%a0%e5%af%86%e6%96%87%e4%bb%b6" class="header-anchor">&lt;/a>1.1.3 打包并加密文件
&lt;/h4>&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>密码短语使用 openssl 随机生成&lt;/li>
&lt;li>文件加密使用 pbkdf2 算法，并对密码加盐处理&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">firmware&lt;/span>&lt;span class="o">=&lt;/span>./firmware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">passphrase&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>openssl rand -base64 32&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -czPf - &lt;span class="si">${&lt;/span>&lt;span class="nv">firmware&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="p">|&lt;/span> openssl enc -e -pbkdf2 -a -salt -k &lt;span class="si">${&lt;/span>&lt;span class="nv">passphrase&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="p">|&lt;/span> dd &lt;span class="nv">of&lt;/span>&lt;span class="o">=&lt;/span>firmware.tar.gz.enc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">passphrase&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="p">|&lt;/span> openssl rsautl -encrypt -pubin -pubin -inkey public.pem -out passphrase.enc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="114-解密和解包">&lt;a href="#114-%e8%a7%a3%e5%af%86%e5%92%8c%e8%a7%a3%e5%8c%85" class="header-anchor">&lt;/a>1.1.4 解密和解包
&lt;/h4>&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>密码短语通过私钥解密&lt;/li>
&lt;li>文件通过与加密相同的 pbkdf2 算法解密&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">passphrase&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>openssl rsautl -decrypt -inkey private.pem -in passphrase.enc&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dd &lt;span class="k">if&lt;/span>&lt;span class="o">=&lt;/span>firmware.tar.gz.enc &lt;span class="p">|&lt;/span> openssl enc -d -pbkdf2 -a -salt -d -k &lt;span class="si">${&lt;/span>&lt;span class="nv">passphrase&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="p">|&lt;/span> tar -zxPf -
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item></channel></rss>